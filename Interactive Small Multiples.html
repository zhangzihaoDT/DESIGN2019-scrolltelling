<!DOCTYPE html>


<script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
<script src="//unpkg.com/d3fc@14.0.1"></script>

<style>
  .upperLine {
    stroke: #1daeeb;
    stroke-width: 2;
  }
  .lowerLine{
    stroke: #f14e58;
    stroke-width: 2;
  }
  #small-multiples > div {
    display: inline-block;
    width: 240px;
    height: 185px;
  }
  .tooltip .x-axis .tick {
    display: none;
  }
  .x-axis .domain, .x-axis .tick path,
  .y-axis .domain, .y-axis .tick path {
    display: none;
  }
  .x-axis {
    height: 1.5em !important;
  }
  .gridline-x {
    stroke: #ccc;
    stroke-dasharray: 4,4
  }
</style>

<div id='small-multiples'></div>

<script>
d3.csv('data/askmefi_category_year.csv',(r) => ({
    category: r.category,
    n: Number(r.n),
    n2: Number(r.n2),
    year: Number(r.year),
    rank: Number(r.rank)
  }))
  .then((data) => {

    var nested = d3.nest()
    	.key(function(k) { return k.category; })
    	.entries(data);
    console.log(nested);

    nested.forEach(g => g.trackball = []);

    var color = d3.scaleLinear()
    .domain(fc.extentLinear()
    .accessors([d => d.rank])(data))
    .range(["#ffffff", "#000000"]);
    
    console.log(fc.extentLinear()
    .accessors([d => d.rank])(data));
    console.log(color(5));

    var yExtent = fc.extentLinear()
      .accessors([function(d) { return d.n+d.n2; }])
      .include([0]);
  
  	var xExtent = fc.extentLinear()
    	.accessors([function(d) { return d.year; }]);

    var area = fc.seriesSvgArea()
      .crossValue(function(d) { return d.year; })
      .mainValue(function(d) { return d.n; })
      .baseValue(function(d) { return d.n2; })
      .curve(d3.curveCatmullRom.alpha(1))
      .decorate(function(selection) {
        selection.enter().attr('fill',color(3))
      });
  
  	var upperLine = fc.seriesSvgLine()
      .crossValue(function(d) { return d.year; })
      .mainValue(function(d) { return d.n; })
      .decorate(function(selection) {
        selection.enter().classed('upperLine', true)
      });
    
    var lowerLine = fc.seriesSvgLine()
      .crossValue(function(d) { return d.year; })
      .mainValue(function(d) { return d.n2; })
      .decorate(function(selection) {
        selection.enter().classed('lowerLine', true)
      });;
  
  	var gridlines = fc.annotationSvgGridline()
    	.xTicks(0)
      .yTicks(3)
    
    var point = fc.seriesSvgPoint()
      .crossValue(d => d.year)
      .mainValue(d => d.value)
    	.size(15)
    	.decorate((selection) => {
        selection.enter()
        	.append('text');        
        selection.select('text')
        	.text(d => d.value)
      })
    
    var line = fc.annotationSvgLine()
    	.orient('vertical')
      .value(d => d.year)
    	.decorate((selection) => {
        selection.enter()
        	.select('.bottom-handle')
        	.append('text');        
        selection.select('.bottom-handle text')
        	.text(d => d.year)
      })
     
  
  	var multi = fc.seriesSvgMulti()
    	.series([area,  gridlines,lowerLine,upperLine,line,point])
      // .mapping(function(data, index, series) {
      //   return data.values;
      // });
      .mapping((data, index, series) => {
        switch (series[index]) {
        case point:            
        case line:
          return data.trackball;
        default:
          return data.values;
        }
      });
    
    var xScale = d3.scaleLinear();
    // create a chart
    var chart = fc.chartSvgCartesian(
        xScale,
        d3.scaleLinear())
      .yDomain(yExtent(data))
    	.xDomain(xExtent(data))
    	.xLabel(function(d) { return d.key; })
    	.yTicks(3)
    	.xTicks(4)
    	.xTickFormat(d3.format('0'))
      .yOrient('left')
    	.plotArea(multi);
  
    // render
    // d3.select('#small-multiples')
    //   .selectAll('div')
    //   .data(nested)
    //   .enter()
    //   .append('div')
    //   .call(chart);
    function render() {
      // render
    	var container = d3.select('#small-multiples')
      var update = container.selectAll('div.multiple')
        .data(nested);
      update.enter()
        .append('div')
      	.classed('multiple', true)
      	.merge(update)
        .call(chart)
        .classed('tooltip', d => d.trackball.length);

      // add the pointer component to the plot-area, re-rendering
      // each time the event fires.
      var pointer = fc.pointer()
        .on('point', (event) => {
          // determine the year
          if (event.length) {
            var year = Math.round(xScale.invert(event[0].x));
            // add the point to each series
            nested.forEach((group) => {
              var value = group.values.find(v => v.year === year);
              group.trackball = [{
                year: year,
                value: value.n2
              }];
            })
          } else {
            nested.forEach(g => g.trackball = [])
          }
          render();
        });

      d3.selectAll('#small-multiples .plot-area')
        .call(pointer);  
    }
  
  	render();
	});
 


</script>