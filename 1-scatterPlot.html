<html>
  <head>
    <title>deck.gl + Mapbox Integration</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdn.jsdelivr.net/npm/deck.gl@7.0.0-rc.1/dist.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js"></script>
    <link rel="stylesheet" type="text/css" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css">
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
  </head>
  <style>
    .container{
      position: absolute;
      top: 0;
      width: 100vw;
      height: 100vh;
    }
    .textYear {
      position: absolute;
      top: 35%;
      left: 50%;
      -moz-transform: translateX(-50%) translateY(-50%);
      -webkit-transform: translateX(-50%) translateY(-50%);
      transform: translateX(-50%) translateY(-50%);
    }
    .operatee {
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    #YearIndicator{
      font-size: 48px;
      font-weight: 700;
      opacity: 1;
      font-family: Open Sans, sans-serif;
    }
  </style>
  <body>
    <div class="container">
        <div class="textYear">
          <span id="YearIndicator">2015</span>
        </div>
        <div id="map" class="operatee"></div>
    </div>
  </body>
  <script type="text/javascript">
    const {MapboxLayer, ScatterplotLayer} = deck;

    // Get a mapbox API access token
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmd6aWhhbyIsImEiOiJjamN6dDF1bzMwenphMzNuMjlqaG1vOTJlIn0.VdSfOPUC85YcWqs3LZeXmA';
    
    const DATA = d3.json("./data/throughput.json");
    const colorScale = d3.scaleLinear()
                          .domain([456,208034,612572,2263015,100983290])
                          .range([
                                  [206, 54,70,230],
                                  [194, 54,118,230],
                                  [179, 57,156,230],
                                  [126, 59,159,230],
                                  [87, 61,145,230]
                                ]);
    const radiusScale = d3.scaleLinear()
                          .domain([456,100983290]).range([20000,200000]);
    // Initialize mapbox map
    const map = new mapboxgl.Map({
      container: 'map',
      center: [108,37],
      zoom: 3.5,
      pitch: 30,
      bearing: 0,
      renderWorldCopies: 1,
      style: "mapbox://styles/zhangzihao/cjv8y65cb1rhs1fqj2hgwdbyx",
      scrollZoom: false
    });
    function renderDataByYear(year){
      return new MapboxLayer({
        id: String(year),
        type: ScatterplotLayer,
        data: DATA.then(function(data) {
                      data.forEach(function(d) {
                        d.position = eval(d.position);
                      });
                      console.log(data[0]);
                      return data.filter(function(d){
                        return d.year == year
                      })
                    }),
        stroked: true,
        lineWidthMinPixels: 2,
        getPosition: d => d.position,
        getRadius: d => radiusScale(d.passenger_throughput),
        getFillColor: d => colorScale(d.passenger_throughput),
        getLineColor: [0, 0, 0,100],
      });
    }
    // Create a mapbox-compatible deck.gl layer
    

    // Insert the layer before mapbox labels
    map.on('load', () => {
      console.log('trigger');
      let currentYear = 2015;
      currentLayer = renderDataByYear(currentYear)
      map.addLayer(currentLayer); // add arc layer
      // currentYear++;
      const interval = setInterval(()=>{
        if (currentYear >= 2017 ) {
          clearInterval(interval)
        }
        map.removeLayer(String(currentYear));
        currentYear += 1;
        currentLayer = renderDataByYear(currentYear)
        document.getElementById('YearIndicator').innerHTML = currentYear;
        // console.log(currentYear + 'interval')
        
        // currentYear++;
        map.addLayer(currentLayer); // add arc layerx
        
      }, 500)
    });
  </script>
</html>
