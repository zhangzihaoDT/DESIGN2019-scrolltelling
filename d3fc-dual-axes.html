<!DOCTYPE html>
<meta charset='utf-8'>
<style>

#chart {
  width: 100%;
  height: 500px;
}
.open path {
  fill: lightblue;
  stroke: none;
}
.bar path {
  fill: #0173DC;
}
text.bar-label{
    font-size: 12px;
    fill: black;
}


</style>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.min.js"></script>
<script src="https://unpkg.com/d3fc@12.0.0/build/d3fc.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
<script src="//unpkg.com/d3fc@14.0.1"></script>

<!-- the structure of the chart, built from a combination of HTML elements, flexbox, and d3fc-group / d3fc-svg -->
<div id='chart'>
  <d3fc-group id='group' style='display: flex; height: 100%; width: 100%; flex-direction: column' auto-resize>
    <div style='flex: 1; display: flex; flex-direction: column'>
        <div style='flex: 1; display: flex; flex-direction: row'>
            <d3fc-svg class='close-axis' style='width: 3em'></d3fc-svg>
            <d3fc-svg class='plot-area' style='flex: 1; overflow: hidden'></d3fc-svg>
            <d3fc-svg class='open-axis' style='width: 3em'></d3fc-svg>
        </div>
        <d3fc-svg class='x-axis' style='height: 2em; margin-left: 3em; margin-right: 3em'></d3fc-svg>
    </div>
  </d3fc-group>
</div>

<script>

d3.csv('data/prices.csv').then(
        function(data){
            data.forEach(function(d) {
                d.date = d.date;
                d.close = +d.close;
                d.open = +d.open;
            });
            return data;
        }
).then(function(data){
    // components for computing the data extent
    var closeExtent = fc.extentLinear().include([0])
    .pad([0, 0.4])
    .accessors([
        function(d) { return d.close; }
    ]);
    var openExtent = fc.extentLinear().include([0])
    .pad([0, 0.2])
    .accessors([
        function(d) { return d.open; }
    ]);

    // scales
    var openScale = d3.scaleLinear();
    var closeScale = d3.scaleLinear();
    var xScale = d3.scaleBand()
		.padding(0.5)
		.align(0.5);

    // axes
    var xAxis = fc.axisBottom()
    .scale(xScale).tickPadding(5);
    var openAxis = fc.axisRight()
    .scale(openScale);
    var closeAxis = fc.axisLeft()
    .scale(closeScale);

    // series
    var closeSeries = fc.seriesSvgPoint()
    .size(30)
    .crossValue(function(d) { return d.date; })
    .mainValue(function(d) { return d.close; })
    .xScale(xScale)
    .yScale(closeScale);

    var openSeries = fc.autoBandwidth(fc.seriesSvgBar())
    .crossValue(function(d) { return d.date; })
    // .align('left')
    .mainValue(function(d) { return d.open; })
    .xScale(xScale)
    .yScale(openScale)
    .decorate(function(selection) {
        // add labels
        selection.enter()
            .append('text')
            .attr('class', 'bar-label')
            .attr('transform', 'translate(-10, -15)')
            .text(d => d3.format('.0%')(d.open));
    });

    // handle the 'draw' event from the d3fc-svg and d3fc-group elements
    d3.select('.close-axis')
    .on('draw', function(d, i, nodes) {
        d3.select(nodes[i])
        .select('svg')
        .attr('viewBox', `${-event.detail.width} 0 ${event.detail.width} ${event.detail.height}`)
        .call(closeAxis);
    });

    d3.select('.open-axis')
    .on('draw', function(d, i, nodes) {
        d3.select(nodes[i])
        .select('svg')
        .call(openAxis);
    });

    d3.select('.x-axis')
    .on('draw', function(d, i, nodes) {
        d3.select(nodes[i])
        .select('svg')
        .attr("transform", "translate(-5,0)")
        .call(xAxis);
    });

    // handle the plot area measure event in order to compute the scale ranges
    d3.select('.plot-area')
    .on('measure', function() {
        xScale.range([0, event.detail.width]);
        openScale.range([event.detail.height, 0]);
        closeScale.range([event.detail.height, 0]);
    })

    // use the data-join component in order to create the inner 'g' elements. This ensures
    // that the elements are only created once.
    var closeJoin = fc.dataJoin('g', 'close');
    var openJoin = fc.dataJoin('g', 'open');
  // set the domain
  openScale.domain(openExtent(data));
  closeScale.domain(closeExtent(data));
  xScale.domain(data.map(d => d.date));

  // render the chart
  d3.select('.plot-area')
    .on('draw', function(d, i, nodes) {
      var svg = d3.select(nodes[i])
        .select('svg');
      closeJoin(svg, [data])
        .call(openSeries);
      openJoin(svg, [data])
        .call(closeSeries);
    });

  d3.select('#group')
      .node()
      .requestRedraw();       
});


</script>