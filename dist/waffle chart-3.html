<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<style>

body {
  font: 18px Arial;
}

p {
  margin: 0;
}
#waffle {
  margin-bottom: 30px;
}

#legend {
  font: 13px Arial;
}

</style>
</head>

<body>
<script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
<div id="title">
  <p>国际（含港澳台）航线TOP30机场的航线类型分布</p>
  </div>
<div id="waffle">
</div>
<div id="legend">
</div>
</body>

<script>

var total = 0;
var width,
    height,
    widthSquares = 10,
    heightSquares = 10,
    squareSize = 20,
    squareValue = 0,
    gap = 1,
    theData = [];  

var color = d3.scaleOrdinal(d3.schemeCategory10);

d3.csv("data/waffle.csv").then(function(data){
     //total
    total = d3.sum(data, function(d) { return d.percentage; });
    //value of a square
    squareValue = total / (widthSquares*heightSquares);
    data.forEach(function(d, i){
        d.percentage = +d.percentage;
        d.units = Math.floor(d.percentage/squareValue);
        theData = theData.concat(
        Array(d.units+1).join(1).split('')
            .map(function(){
                return {  
                    squareValue:squareValue,                      
                    units: d.units,
                    percentage: d.percentage,
                    groupIndex: i};
            })
        );
        console.log(theData);
    });
    renderWaffle();
});
function renderWaffle(){
  width = (squareSize*widthSquares) + widthSquares*gap + 25;
  height = (squareSize*heightSquares) + heightSquares*gap + 25;

  var waffle = d3.select("#waffle")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .selectAll("div")
      .data(theData)
      .enter()
      .append("rect")
      .attr("width", squareSize)
      .attr("height", squareSize)
      .attr("fill", function(d)
      {
        return color(d.groupIndex);
      })
      .attr("x", function(d, i)
        {
          //group n squares for column
          col = Math.floor(i/heightSquares);
          return (col*squareSize) + (col*gap);
        })
      .attr("y", function(d, i)
      {
        row = i%heightSquares;
        return (heightSquares*squareSize) - ((row*squareSize) + (row*gap))
      });
}
  


</script>
</html>