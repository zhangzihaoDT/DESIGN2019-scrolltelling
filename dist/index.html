<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>deck.gl Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mapbox-gl@0.53.1/dist/mapbox-gl.css">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <article class="article">
    <h1>凌空经济</h1>
    <section class="intro">
      <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Veritatis reiciendis cum unde commodi eos! Maiores quisquam provident inventore eligendi a iste quidem quasi beatae perspiciatis autem. Laborum ullam sed recusandae.</p>
    </section>
    <section id="mapor" class="part">
      <section class="group">
        <p class="opening">Lorem ipsum, dolor sit amet consectetur adipisicing elit. Ab tempore ipsum beatae quas placeat totam, libero, rem voluptas cumque distinctio nam est voluptates deleniti reiciendis suscipit! Blanditiis consectetur cum saepe?</p>
      </section>
      <section class="group">
        <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Ea dolorem, itaque ducimus, unde explicabo aliquid perspiciatis laborum quibusdam a corporis, laudantium culpa quod labore amet quia. Quam labore molestias maiores. Lorem ipsum dolor sit amet consectetur adipisicing elit. Reiciendis nemo quo nesciunt, eius similique doloribus est, possimus iure doloremque quaerat laboriosam quos cupiditate. Ea repellendus voluptatum cumque dolor aut quasi?</p>
      </section>
      <section class="group">
        <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Nam accusantium illo vero fugiat, corrupti, saepe exercitationem cumque rerum rem perspiciatis tempore vitae, excepturi quae eligendi laudantium dolore qui? Suscipit, impedit. Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsum, porro animi odio asperiores quia voluptatibus labore fugit, odit ab quos dignissimos, praesentium minus iure voluptas deleniti at impedit totam perferendis. Lorem ipsum dolor sit amet consectetur adipisicing elit. Harum accusamus earum adipisci ut similique animi accusantium, quae perspiciatis quibusdam aperiam aut, repudiandae sunt veniam incidunt saepe obcaecati optio culpa. Ipsam.</p>
      </section>
      <section class="group">
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Commodi culpa excepturi, eos voluptas, qui eius accusamus recusandae quibusdam numquam dolorem asperiores cupiditate temporibus facilis illum et rem pariatur. Neque, maiores.</p>
      </section>
      <section class="group">
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Vitae reiciendis accusantium doloribus delectus? Autem harum consectetur amet aspernatur excepturi repudiandae corporis reprehenderit iusto alias nam, distinctio hic minus eligendi consequatur?</p>
      </section>
      <section class="group">
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Illo commodi necessitatibus perferendis ducimus, mollitia labore ipsum. Dicta incidunt illum soluta corporis unde rerum. Eveniet quo maiores, ratione minima laborum eligendi. </p>
      </section>
      <section id="mapee" class="mask">
        <div id="map" class="operatee"></div>
      </section>
    </section>
    <section class="part">
      <section>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ad atque facilis mollitia culpa earum asperiores, nisi provident inventore recusandae libero assumenda laboriosam sint. Minus eligendi nostrum veniam nesciunt placeat atque!</p>
      </section>
      <section class="mask">
        <div></div>
      </section>
    </section>
    <section id="gridor" class="part">
      <section class="group">
        <p class="opening">Lorem ipsum dolor sit amet consectetur adipisicing elit. Neque doloribus asperiores non atque explicabo nihil, perferendis consequatur rerum dicta quia odit recusandae vitae ipsa quo, maiores in. Tenetur, odit illo.</p>
      </section>
      <section class="group">
        <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Quis est recusandae, dignissimos necessitatibus aut delectus ad optio labore molestiae eveniet, incidunt minima ipsa eligendi animi. Debitis repellendus reprehenderit non assumenda.</p>
      </section>
      <section class="group">
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Deleniti maiores fuga reiciendis cupiditate? Natus ab, alias quo, delectus sint a atque repellat rerum eos impedit adipisci minus tempora dolorem excepturi?</p>
      </section>
      <section class="group">
        <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Beatae cumque modi similique sed eligendi debitis ullam facilis incidunt, obcaecati animi magnam! Excepturi adipisci, fuga ad veritatis eaque reprehenderit est dicta?</p>
      </section>
      <section id="gridee" class="mask">
        <div id="grid" class="operatee"></div>
      </section>
    </section>
    <section class="finally">
      <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Impedit veniam in labore laboriosam atque commodi maiores debitis, possimus quidem odit sit ipsa quas fuga itaque eaque accusamus! Non, exercitationem laboriosam.</p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Amet dicta atque cumque esse dolorem beatae nihil asperiores totam inventore id, quia quasi possimus ipsam eaque quas aut necessitatibus blanditiis? Ullam.</p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Animi perferendis sit tempora officia totam deleniti. Ut, ipsum. Totam, mollitia alias? Ab quas quam sint illum officiis quidem, adipisci blanditiis quae.</p>
      <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Quidem illo incidunt neque amet, sunt corporis enim eveniet cumque quas beatae maiores placeat repudiandae quo asperiores ea est! Repellat, quidem illo.</p>
      <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Odio suscipit quos numquam vel officia quae vitae saepe velit repudiandae recusandae nostrum veniam in inventore aut hic, reprehenderit doloribus sapiente temporibus.</p>
    </section>
  </article>
</body>
<script src="https://cdn.jsdelivr.net/npm/scrollmagic@2.0.6/scrollmagic/uncompressed/ScrollMagic.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/scrollmagic@2.0.5/scrollmagic/minified/plugins/debug.addIndicators.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/deck.gl@7.0.0-rc.1/dist.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mapbox-gl@0.53.1/dist/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
<script>
window.onload = function () {
  const controller = new ScrollMagic.Controller()
  const { Deck, MapboxLayer, ScatterplotLayer, ArcLayer, HexagonLayer } = window.deck

  mapboxgl.accessToken = "pk.eyJ1IjoidWJlcmRhdGEiLCJhIjoiY2pudzRtaWloMDAzcTN2bzN1aXdxZHB5bSJ9.2bkj3IiRC8wj3jLThvDGdA"

  // var lines_article = document.getElementById('lines_article')
  // var lines_vis = document.getElementById('lines_vis')

  // new ScrollMagic.Scene({
  //   triggerElement: lines_article,
  //   duration: lines_article.scrollHeight,
  //   triggerHook: 0
  // })
  // .addTo(controller)
  // .on('start', e => {
  //   lines_vis
  //   new MapboxLayers()
  // })

  // functions
  const operate = (or, ee) => {
    let operator = document.getElementById(or.id)
    let operatee = document.getElementById(ee)
    return new ScrollMagic.Scene({
        triggerElement: operator, 
        duration: operator.scrollHeight,
        triggerHook: 0
    })
    .addTo(controller)
    .addIndicators()
    .on("start", e => {
      let classList = operatee.classList
      return e.scrollDirection === "FORWARD" 
      ? classList.add(or.effect) 
      : classList.remove(or.effect)
    })
  }

  const act = (actor, actee, payload) => {
    let type = payload instanceof MapboxLayer

    return new ScrollMagic.Scene({
        triggerElement: actor, 
        duration: actor.scrollHeight,
        triggerHook: 0
      })
      .addTo(controller)
      .addIndicators()
      .on("enter", e => type ? actee.addLayer(payload) : payload.trigger(payload.element))
      .on("leave", e => type ? actee.removeLayer(payload.id) : null)
  }

  const operations = [{
    operators: [{
      id: 'mapor',
      effect: "during"
    }, {
      id: 'mapee',
      effect: "end"
    }],
    operatee: 'map'
    },{
    operators: [{
      id: 'gridor',
      effect: "during"
    }, {
      id: 'gridee',
      effect: "end"
    }],
    operatee: 'grid'
  }]

  // start

  const map = new mapboxgl.Map({
    container: document.getElementById('map'),
    style: "mapbox://styles/mapbox/dark-v9",
    width: '100%',
    height: '100%',
    pitch: 45,
    bearing: 0,
    renderWorldCopies: 1,
    center: [108,39.915085],
    zoom: 3.2,
    interactive: false
  });

  map.on('load', function () {
    var adminLayers = ['admin-0-boundary', 'admin-1-boundary', 'admin-0-boundary-disputed', 'admin-1-boundary-bg', 'admin-0-boundary-bg'];
    adminLayers.forEach(function(adminLayer) {
      map.setFilter(adminLayer, ["match", ["get", "worldview"], ["all", "CN"], true, false]);
    });
    map.setLayoutProperty('country-label', 'text-field', ['get', 'name_zh-Hans']);
  })


  const gridded = (container, data) => {
    var barHeight = 20;
    var svg = d3.select(container).select('svg')
    if (!svg.empty()) svg.remove()
    return d3.select(container)
          .append("svg")
          .selectAll('rect')
          .data(data)
          .enter()
          .append('rect')
          .attr('width', function(d) {  return d; })
          .attr('height', barHeight - 1)
          .attr('transform', function(d, i) {
            return "translate(0," + i * barHeight + ")";
          });
  }

  const layers = [
    // 0
    new MapboxLayer({
      id: 'traffic',
      type: ScatterplotLayer,
      data: [{
        name: 'Colma (COLM)', 
        radius: 10000, 
        coordinates: [116.405285,39.904989]
      }, {
        name: 'Colma (COLM)', 
        radius: 10000, 
        coordinates: [121.472644,31.231706]
      }, {
        name: 'Colma (COLM)', 
        radius: 10000, 
        coordinates: [114.085947,22.547]
      }, {
        name: 'Colma (COLM)', 
        radius: 10000, 
        coordinates: [106.504962,29.533155]
      }],
      pickable: true,
      opacity: 0.8,
      stroked: true,
      filled: true,
      radiusScale: 6,
      lineWidthMinPixels: 1,
      getPosition: d => d.coordinates,
      getRadius: d => d.radius,
      getFillColor: d => [255, 140, 0],
      getLineColor: d => [0, 0, 0],
    }),
    // 1
    new MapboxLayer({
      id: 'total',
      type: ArcLayer,
      data: [{
        inbound: 72633,
        outbound: 74735,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '上海',
          coordinates: [121.472644,31.231706]
        }
      }, {
        inbound: 72633,
        outbound: 74735,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '深圳',
          coordinates: [114.085947,22.547]
        }
      }, {
        inbound: 34323,
        outbound: 90003,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '重庆',
          coordinates: [106.504962,29.533155]
        }
      }],
      getPosition: d => d.position,
      getRadius: d => d.size,
      pickable: true,
      getStrokeWidth: 2,
      getSourcePosition: d => d.from.coordinates,
      getTargetPosition: d => d.to.coordinates,
      getSourceColor: d => [Math.sqrt(d.inbound), 140, 0],
      getTargetColor: d => [Math.sqrt(d.outbound), 140, 0],
    }),
    // 2
    new MapboxLayer({
      id: 'zero',
      type: ArcLayer,
      data: [{
        inbound: 72633,
        outbound: 74735,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '上海',
          coordinates: [121.472644,31.231706]
        }
      }],
      getPosition: d => d.position,
      getRadius: d => d.size,
      pickable: true,
      getStrokeWidth: 2,
      getSourcePosition: d => d.from.coordinates,
      getTargetPosition: d => d.to.coordinates,
      getSourceColor: d => [Math.sqrt(d.inbound), 140, 0],
      getTargetColor: d => [Math.sqrt(d.outbound), 140, 0],
    }),
    // 3
    new MapboxLayer({
      id: 'one',
      type: ArcLayer,
      data: [{
        inbound: 72633,
        outbound: 74735,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '深圳',
          coordinates: [114.085947,22.547]
        }
      }],
      getPosition: d => d.position,
      getRadius: d => d.size,
      pickable: true,
      getStrokeWidth: 2,
      getSourcePosition: d => d.from.coordinates,
      getTargetPosition: d => d.to.coordinates,
      getSourceColor: d => [Math.sqrt(d.inbound), 140, 0],
      getTargetColor: d => [Math.sqrt(d.outbound), 140, 0],
    }),
    // 4
    new MapboxLayer({
      id: 'two',
      type: ArcLayer,
      data: [{
        inbound: 72633,
        outbound: 74735,
        from: {
          name: '北京',
          coordinates: [116.405285,39.904989]
        },
        to: {
          name: '重庆',
          coordinates: [106.504962,29.533155]
        }
      }],
      getPosition: d => d.position,
      getRadius: d => d.size,
      pickable: true,
      getStrokeWidth: 2,
      getSourcePosition: d => d.from.coordinates,
      getTargetPosition: d => d.to.coordinates,
      getSourceColor: d => [Math.sqrt(d.inbound), 140, 0],
      getTargetColor: d => [Math.sqrt(d.outbound), 140, 0],
    }),
    // 5
    {
      element: map.getCanvasContainer(),
      trigger: function (container) {
        var svg = d3.select(container).append("svg")
        
      }
    },
    // 7
    {
      element: document.getElementById('grid'),
      trigger: function (container) {
        gridded(container, new Array(10).fill(undefined).map(e => Math.floor(Math.random() * 100)))
      }
    },
    // 8
    {
      element: document.getElementById('grid'),
      trigger: function (container) {
        gridded(container, new Array(10).fill(undefined).map(e => Math.floor(Math.random() * 100)))
      }
    },
    // 9
    {
      element: document.getElementById('grid'),
      trigger: function (container) {
        gridded(container, new Array(10).fill(undefined).map(e => Math.floor(Math.random() * 100)))
      }
    },
    // 10
    {
      element: document.getElementById('grid'),
      trigger: function (container) {
        gridded(container, new Array(10).fill(undefined).map(e => Math.floor(Math.random() * 100)))
      }
    }
  ]

  // end

  operations.forEach(operation => {
    operation.operators.forEach(operator => {
      operate(operator, operation.operatee)
    })
  })

  document.querySelectorAll('.group').forEach(element => act(element, map, layers.shift()))

}
</script>
</html>
