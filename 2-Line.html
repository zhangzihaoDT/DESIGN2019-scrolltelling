<html>
  <head>
    <title>deck.gl + Mapbox Integration</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdn.jsdelivr.net/npm/deck.gl@7.0.0-rc.1/dist.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js"></script>
    <link rel="stylesheet" type="text/css" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css">
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
  </head>
  <body>
    <div id="map" style="width: 100vw; height: 100vh"></div>
  </body>
  <script type="text/javascript">
    const {MapboxLayer, LineLayer,ScatterplotLayer} = deck;
    // Get a mapbox API access token
    mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmd6aWhhbyIsImEiOiJjamN6dDF1bzMwenphMzNuMjlqaG1vOTJlIn0.VdSfOPUC85YcWqs3LZeXmA';
    const AIRPORTS = d3.json("./data/throughput.json").then(function(data) {
                      data.forEach(function(d) {
                        d.position = eval(d.position);
                      });
                      console.log(data[0]);
                      return data.filter(function(d){
                        return d.year == 2018
                      })
                    });
    const FLIGHT_PATHS = d3.json("./data/my_data.json").then(function(data) {
                      data.forEach(function(d) {
                        d.source = eval(d.source);
                        d.target = eval(d.target);
                      });
                      // console.log(data[0]);
                      return data.filter(function(d){
                        return d.year == 2018
                      })
                    });
    const radiusScale = d3.scaleLinear()
                          .domain([456,100983290]).range([20000,200000]); 
    const opacityScale = d3.scaleLinear()
                          .domain([3,28902]).range([1,255]);            
    // Initialize mapbox map
    const map = new mapboxgl.Map({
      container: 'map',
      // style: "mapbox://styles/mapbox/dark-v9",
      style: "mapbox://styles/zhangzihao/cjn09g7yq52jp2ro8ri6tjun6",
      // scrollZoom: false,
      center: [108,37],
      zoom: 3.72,
      pitch: 0,
      bearing: 0
    });
    
    const myDeckLayer2 = new MapboxLayer({
        type:ScatterplotLayer,
        id: 'airports',
        data: AIRPORTS,
        radiusScale: 1,
        getPosition: d => d.position,
        getFillColor: [255, 140, 0,255],
        getRadius: d => radiusScale(d.passenger_throughput),
      });

    // Create a mapbox-compatible deck.gl layer
    const myDeckLayer = new MapboxLayer({
      type:LineLayer,
      id: 'flight-paths',
      data: FLIGHT_PATHS,
      pickable: true,
      getWidth: 5,
      getSourcePosition: d => d.source,
      getTargetPosition: d => d.target,
      getColor: d => [29,174, 235,opacityScale(d.flights_in+d.flights_out)],
      getWidth: 4,
    });

    // Insert the layer before mapbox labels
    map.on('load', () => {
      map.addLayer(myDeckLayer, 'waterway-label');
      // map.addLayer(myDeckLayer2);
    });
  </script>
</html>
