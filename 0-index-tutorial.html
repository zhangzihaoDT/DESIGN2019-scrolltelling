<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mapbox-gl@0.53.1/dist/mapbox-gl.css">
    <style>
        #container {
            width: 80vw;
            padding-bottom: 100vh;
            margin: 0 auto;
        }
        .wrapper, #map {
            height: 50vh;
        }
        h1, p {
            padding: 0 20vw;
        }
        p {
            margin: 36px 0;
        }
        img {
            width: 100%;
        }
        .pin {
            position: fixed;
            top: 0;
            width: 80vw;
            margin: auto;
            z-index: -1;
        }
        .group {
            position: relative;
        }
        .bottom {
            position: absolute;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="intro">
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quidem dolores modi mollitia nisi tenetur hic neque praesentium sunt. Beatae delectus ipsum similique, obcaecati veniam dolores id iste distinctio corrupti veritatis!</p>
            <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Sunt velit modi dolore quas tempora nam, sed et quo quasi fugit impedit distinctio nulla eveniet necessitatibus labore omnis reiciendis fuga doloribus.</p>
            <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Hic exercitationem incidunt sint ex maxime quae nam magni debitis inventore facere est consequuntur deserunt eligendi non, molestiae, a quibusdam culpa laborum?</p>
            <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Nemo commodi modi beatae in harum atque minus autem, reprehenderit, cupiditate maiores distinctio nihil amet ab est laboriosam veritatis porro corporis nobis.</p>
            <div>
                <img src="https://via.placeholder.com/1920x1080" alt="">
            </div>
        </div>
        <div class="artitle">
            <h1 class="title">标题</h1>
            <h2 class="author"></h2>
            <div></div>
            <div class="group">
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Vero optio consequatur asperiores voluptatem illo eos, esse, magni aut beatae quas eius vel neque voluptatum in nobis molestias nemo, aspernatur non!</p>
                <p>Lorem, ipsum dolor sit amet consectetur adipisicing elit. Rerum non fugit facilis odio veniam asperiores quae dicta, quas quidem? Cumque repudiandae ipsum assumenda iure explicabo quaerat architecto, quam dolor ullam!</p>
                <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Sed delectus adipisci repellendus alias est earum quasi aut in et optio provident quod eos illo exercitationem nulla, labore impedit aperiam. Non?</p>
                <div class="wrapper" id="mapbox-wrapper">
                    <div id="map"></div>
                </div>
                <div class="sub-group" id="mapbox-sub">
                    <div id="act-zero">
                        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Unde numquam est in nemo hic quisquam dolorum cumque sapiente reprehenderit laboriosam nihil illum, optio nisi possimus iure. Rem at omnis non.</p>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Distinctio placeat, pariatur molestias expedita saepe rerum. Repellat rem atque ducimus voluptatibus! Nostrum atque consequuntur harum dolor, quia modi soluta molestiae quidem.</p>
                    </div>
                    <div id="act-one">
                        <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Facere sapiente libero, tenetur eius aut harum nobis dolorem veritatis voluptas obcaecati voluptates atque veniam, dicta nam odit doloremque ab mollitia! Quibusdam!</p>
                        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Blanditiis cumque fugiat doloribus accusamus minus tempora illo aspernatur dolorum, tempore nisi similique id. Natus id consequuntur fuga asperiores tenetur aspernatur quam.</p>
                    </div>
                    <p id="act-two">Lorem ipsum, dolor sit amet consectetur adipisicing elit. Nulla repudiandae amet modi voluptatum. Ipsum, illo. Voluptatem delectus nesciunt recusandae doloribus culpa vitae aut voluptate ea fuga. Nostrum minus placeat impedit.</p>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Sapiente dolorem inventore voluptatum exercitationem recusandae nam quas, sunt ea, molestiae autem iure. Dolores doloribus quisquam nisi, explicabo deleniti architecto cupiditate autem.</p>        
                </div>
                <div class="wrapper">

                </div>
            </div>
            <div class="group">
                
            </div>
            <div class="group">
                
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/scrollmagic@2.0.6/scrollmagic/uncompressed/ScrollMagic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scrollmagic@2.0.5/scrollmagic/minified/plugins/debug.addIndicators.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/deck.gl@7.0.0-rc.1/dist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl@0.53.1/dist/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2/dist/d3.min.js"></script>
    <script>
    window.onload = function() {
        const map = document.querySelector('#map')
        // const groups = document.querySelectorAll(".group")
        const {MapboxLayer, ScatterplotLayer} = deck;
        const controller = new ScrollMagic.Controller();

        let timers = {}
        let indexes = {}

        // Get a mapbox API access token
        mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhbmd6aWhhbyIsImEiOiJjamN6dDF1bzMwenphMzNuMjlqaG1vOTJlIn0.VdSfOPUC85YcWqs3LZeXmA';

        // Initialize mapbox map
        const mapbox = new mapboxgl.Map({
            container: 'map',
            center: [108,37],
            zoom: 3.5,
            pitch: 30,
            bearing: 0,
            renderWorldCopies: 1,
            style: "mapbox://styles/zhangzihao/cjv8y65cb1rhs1fqj2hgwdbyx",
            scrollZoom: false
        });

        const layers = {
            "zero": [new MapboxLayer({
                id: "2015",
                type: ScatterplotLayer,
                data: [{
                    position: [108,37],
                    radius: 100000,
                    color: [255,0,0]
                }],
                stroked: true,
                lineWidthminPixels: 2,
                getPosition: d => d.position,
                getRadius: d => d.radius,
                getFillColor: d => d.color,
                getLineColor: [0,0,0,100]
            }), new MapboxLayer({
                id: "2016",
                type: ScatterplotLayer,
                data: [{
                    position: [108,37],
                    radius: 200000,
                    color: [255,0,0]
                }],
                stroked: true,
                lineWidthminPixels: 2,
                getPosition: d => d.position,
                getRadius: d => d.radius,
                getFillColor: d => d.color,
                getLineColor: [0,0,0,100]
            }), new MapboxLayer({
                id: "2017",
                type: ScatterplotLayer,
                data: [{
                    position: [108,37],
                    radius: 300000,
                    color: [255,0,0]
                }],
                stroked: true,
                lineWidthminPixels: 2,
                getPosition: d => d.position,
                getRadius: d => d.radius,
                getFillColor: d => d.color,
                getLineColor: [0,0,0,100]
            })]
        }

        const scene1 = new ScrollMagic.Scene({
            triggerElement: document.querySelector('#mapbox-wrapper'),
            duration: document.querySelector('#mapbox-wrapper').scrollHeight + document.querySelector('#mapbox-sub').scrollHeight + 36,
            triggerHook: 0
        })
        .addTo(controller)
        .addIndicators()
        .on("enter", function (event) {
            map.classList.remove('bottom')
            map.classList.add('pin')
        })
        .on("leave", function (event) {
            if(event.scrollDirection === 'REVERSE') {
                map.classList.remove('pin')
            } else if(event.scrollDirection === 'FORWARD') {
                map.classList.replace('pin', 'bottom')
            }
        })

        const scene_act_zero = new ScrollMagic.Scene({
            triggerElement: document.querySelector('#act-zero'),
            duration: document.querySelector('#act-zero').scrollHeight,
            triggerHook: 0.25
        })
        .addTo(controller)
        .addIndicators()
        .on("enter", function (event) {
            indexes.act_zero = 0
            timers.act_zero = setInterval(function () {
                index = indexes.act_zero
                previous = layers.zero[index-1 < 0 ? layers.zero.length-1 : index-1].id
                if (mapbox.getLayer(previous)) {
                    mapbox.removeLayer(previous)
                }
                mapbox.addLayer(layers.zero[index])
                indexes.act_zero = (index + 1) % layers.zero.length
            }, 500)
        })
        .on("leave", function (event) {
            if(timers.act_zero) {
                layers.zero.forEach(function (layer) {
                    if (mapbox.getLayer(layer.id)) {
                        mapbox.removeLayer(layer.id)
                    }
                })
                clearInterval(timers.act_zero)
            }
        })

        const arcsLayer = ''
        const airportsLayer = ''

        const scene_act_one = new ScrollMagic.Scene({
            triggerElement: document.querySelector('#act-one'),
            duration: document.querySelector('#act-one').scrollHeight,
            triggerHook: 0.25
        })
        .addTo(controller)
        .addIndicators()
        .on("enter", function (event) {
            mapbox.addLayer(arcsLayer)
            mapbox.addLayer(airportsLayer)

            var coef = 0.001
            const animationInterval = setInterval(function () {
                coef += 0.005
                if (coef >= 1) {
                    clearInterval(animationInterval)
                }
                arcsLayer.setProps({coef})
            }, 10)
        })
        .on("leave", function (event) {
            mapbox.removeLayer(airportsLayer)
            mapbox.removeLayer(arcsLayer)
        })



//         const operate = (or, ee) => {
//     let operator = document.getElementById(or.id)
//     let operatee = document.getElementById(ee)
//     return new ScrollMagic.Scene({
//         triggerElement: operator, 
//         duration: operator.scrollHeight,
//         triggerHook: 0
//     })
//     .addTo(controller)
//     .addIndicators()
//     .on("start", e => {
//       let classList = operatee.classList
//       return e.scrollDirection === "FORWARD" 
//       ? classList.add(or.effect) 
//       : classList.remove(or.effect)
//     })
//   }

    }
    </script>
</body>
</html>